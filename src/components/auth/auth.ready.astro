---
import { app } from "../../firebase/server";
import { getAuth, UserRecord } from "firebase-admin/auth";
import SignedIn from './auth.signedin.astro';
import SignedOut from './auth.signedout.astro';

const getUser : () => Promise<UserRecord | null> = 
  async () => {
    if (!Astro.cookies.has("__session")) {
        return null;
    }
    const sessionCookie = Astro.cookies.get("__session")!.value;
    const auth = getAuth(app);
    try {
      const decodedCookie = await auth.verifySessionCookie(sessionCookie);
      return await auth.getUser(decodedCookie.uid);
    } catch (error) {
      console.error(error);
      Astro.cookies.delete("__session", { path: '/' });
      return null;
    }
  }

const isAuthenticated : (user: UserRecord | null) => boolean =
  (user) => user?.providerData && user.providerData.length > 0 || false;

const user = await getUser();
---
{ await isAuthenticated(user) ? <SignedIn/> : <SignedOut/> }

